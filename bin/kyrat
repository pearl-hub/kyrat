#!/usr/bin/env bash
# This is a kyrat wrapper that introduces few Pearl utilities.
# This creates few symlink to ~/.config/kyrat/pearl_* from scripts
# of some Pearl packages.

set -e -o pipefail

# PATH needs to be updated since GNU Coreutils is required in OSX
# environments. Buava `osx_update_path` cannot be used because in
# order to load osx-compat.sh file the `readlink` command is
# required first (circular dependency).
GNUBIN="/usr/local/opt/coreutils/libexec/gnubin"
[ -d "$GNUBIN" ] && PATH="$GNUBIN:$PATH"

# Identify the location of the current package
PKG_ROOT="$(readlink -f $(dirname $(readlink -f "$0"))/..)"

# Import buava library if needed during the script logic
source $PKG_ROOT/buava/lib/utils.sh

KYRAT=$PKG_ROOT/module/bin/kyrat

KYRAT_HOME=${HOME}/.config/kyrat

KYRAT_ALIASES=${KYRAT_HOME}/bashrc.d/pearl_aliases.sh
PEARL_ALIASES=$PEARL_HOME/packages/pearl/sesaila/aliases

KYRAT_BASH=${KYRAT_HOME}/bashrc.d/pearl_bash.sh
PEARL_BASH=$PEARL_HOME/packages/pearl/dot-bash/bash.bash

KYRAT_INPUTRC=${KYRAT_HOME}/inputrc.d/pearl_inputrc
PEARL_INPUTRC=$PEARL_HOME/packages/pearl/dot-bash/inputrc

KYRAT_VIM=${KYRAT_HOME}/vimrc.d/pearl_vimrc
PEARL_VIM=$PEARL_HOME/packages/pearl/dot-vim/vimrc

# Creates kyrat home directories if they do not exist
mkdir -p "${KYRAT_HOME}/bashrc.d/"
mkdir -p "${KYRAT_HOME}/inputrc.d/"
mkdir -p "${KYRAT_HOME}/vimrc.d/"

[ -f "${PEARL_ALIASES}" ] && \
    link_to "${PEARL_ALIASES}" "${KYRAT_ALIASES}"
[ -f "${PEARL_BASH}" ] && \
    link_to "${PEARL_BASH}" "${KYRAT_BASH}"
[ -f "${PEARL_INPUTRC}" ] && \
    link_to "${PEARL_INPUTRC}" "${KYRAT_INPUTRC}"
[ -f "${PEARL_VIM}" ] && \
    link_to "${PEARL_VIM}" "${KYRAT_VIM}"

$KYRAT "$@"
