#!/usr/bin/env bash
# This is a kyrat wrapper that introduces few Pearl utilities.
# This creates few symlink to ~/.config/kyrat/pearl_* from scripts
# of some Pearl packages.

set -e -o pipefail

[[ -z "$PEARL_ROOT" ]] && { echo "Error: The variable PEARL_ROOT must be specified in order to run this script."; exit 1; }
[[ -d "$PEARL_ROOT" ]] || { echo "Error: The value in variable PEARL_ROOT is not a directory."; exit 2; }

source $PEARL_ROOT/lib/utils/utils.sh
source $PEARL_ROOT/lib/utils/osx-compat.sh
# Update PATH for OSX
pearl_update_path

KYRAT=$(dirname "$(readlink -f $0)")/../module/bin/kyrat

KYRAT_HOME=${HOME}/.config/kyrat

KYRAT_ALIASES=${KYRAT_HOME}/bashrc.d/pearl_aliases.sh
PEARL_ALIASES=$PEARL_HOME/packages/pearl/sesaila/aliases

KYRAT_OPS=${KYRAT_HOME}/bashrc.d/pearl_ops.sh
PEARL_OPS=$PEARL_HOME/packages/pearl/ops/ops.sh

KYRAT_BASH=${KYRAT_HOME}/bashrc.d/pearl_bash.sh
PEARL_BASH=$PEARL_HOME/packages/pearl/dot-bash/bash.bash

KYRAT_INPUTRC=${KYRAT_HOME}/inputrc.d/pearl_inputrc
PEARL_INPUTRC=$PEARL_HOME/packages/pearl/dot-bash/inputrc

KYRAT_VIM=${KYRAT_HOME}/vimrc.d/pearl_vimrc
PEARL_VIM=$PEARL_HOME/packages/pearl/dot-vim/vimrc

# Creates kyrat home directories if they do not exist
mkdir -p "${KYRAT_HOME}/bashrc.d/"
mkdir -p "${KYRAT_HOME}/inputrc.d/"
mkdir -p "${KYRAT_HOME}/vimrc.d/"

[ -f "${PEARL_ALIASES}" ] && \
    link_to "${PEARL_ALIASES}" "${KYRAT_ALIASES}"
[ -f "${PEARL_OPS}" ] && \
    link_to "${PEARL_OPS}" "${KYRAT_OPS}"
[ -f "${PEARL_BASH}" ] && \
    link_to "${PEARL_BASH}" "${KYRAT_BASH}"
[ -f "${PEARL_INPUTRC}" ] && \
    link_to "${PEARL_INPUTRC}" "${KYRAT_INPUTRC}"
[ -f "${PEARL_VIM}" ] && \
    link_to "${PEARL_VIM}" "${KYRAT_VIM}"

$KYRAT "$@"
